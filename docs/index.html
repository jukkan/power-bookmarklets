<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Platform Bookmarklets</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
            line-height: 1.6;
            color: #333;
        }
        .bookmarklet {
            background: #f6f8fa;
            border: 2px solid #0969da;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .bookmarklet h3 {
            margin-top: 0;
            color: #0969da;
        }
        .drag-link {
            display: inline-block;
            background: #0969da;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: move;
        }
        .drag-link:hover {
            background: #0550ae;
        }
        .manual-steps {
            background: #fff8c5;
            border-left: 4px solid #fb8500;
            padding: 15px;
            margin: 20px 0;
        }
        code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        pre {
            background: #f6f8fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Power Platform Bookmarklets</h1>
    <p>Quick browser tools for Power Platform devs. Drag bookmarklets to your bookmarks bar.</p>

    <div class="manual-steps">
        <strong>‚ö†Ô∏è Can't drag?</strong> Some browsers block dragging. Use the manual install steps below each bookmarklet.
    </div>

    <div class="bookmarklet">
        <h3>üìã Get Table Metadata</h3>
        <p>Extracts Dataverse table schema from a model-driven app view and copies it as a markdown table. Perfect for pasting into Claude, Copilot, or ChatGPT.</p>
        
        <p><strong>‚ú® New:</strong> Now includes choice/picklist values with their IDs and labels!</p>
        
        <p><strong>Install:</strong> Drag this to your bookmarks bar ‚Üí</p>
        <a href="javascript:(function(){const e=new URLSearchParams(window.location.search).get('etn');if(!e)return alert('No entity in URL. Go to a table view first.');const t=window.location.origin,n=`${t}/api/data/v9.2/EntityDefinitions(LogicalName='${e}')`,a=`${n}?$select=LogicalName&$expand=Attributes($select=LogicalName,DisplayName,AttributeType)`,o=`${n}/Attributes/Microsoft.Dynamics.CRM.PicklistAttributeMetadata?$select=LogicalName&$expand=OptionSet($select=Options)`;Promise.all([fetch(a).then(r=>r.json()),fetch(o).then(r=>r.json())]).then(([d,p])=>{const opts={};p.value.forEach(i=>{i.OptionSet?.Options&&(opts[i.LogicalName]=i.OptionSet.Options.map(o=>`${o.Value}: ${o.Label?.LocalizedLabels?.[0]?.Label||o.Value}`).join(', '))});const rows=d.Attributes.filter(a=>!a.LogicalName.match(/^(created|modified|owner|owning|statecode|statuscode|versionnumber|importsequencenumber|overriddencreatedon|timezoneruleversionnumber|utcconversiontimezonecode)/)).map(a=>{const name=a.DisplayName?.LocalizedLabels?.[0]?.Label||'',opt=opts[a.LogicalName]?` [${opts[a.LogicalName]}]`:'';return`| ${a.LogicalName} | ${name} | ${a.AttributeType}${opt} |`}).join('\n'),table=`**Table: ${e}**\n\n| LogicalName | DisplayName | AttributeType |\n|-------------|-------------|---------------|\n${rows}`;navigator.clipboard.writeText(table).then(()=>alert(`‚úì Schema copied!\n\n${d.Attributes.length} total, ${rows.split('\n').length} shown\n${Object.keys(opts).length} choice fields`))}).catch(err=>alert('Error: '+err.message))})();" class="drag-link">Get Table Metadata</a>

        <details style="margin-top: 15px;">
            <summary><strong>Manual install (if drag doesn't work)</strong></summary>
            <ol>
                <li>Right-click your bookmarks bar ‚Üí <code>Add page</code> or <code>Add bookmark</code></li>
                <li>Name: <code>Get Table Metadata</code></li>
                <li>URL: Copy the code below and paste it</li>
            </ol>
            <pre style="font-size: 11px; max-height: 150px; overflow-y: auto;">javascript:(function(){const e=new URLSearchParams(window.location.search).get('etn');if(!e)return alert('No entity in URL. Go to a table view first.');const t=window.location.origin,n=`${t}/api/data/v9.2/EntityDefinitions(LogicalName='${e}')`,a=`${n}?$select=LogicalName&$expand=Attributes($select=LogicalName,DisplayName,AttributeType)`,o=`${n}/Attributes/Microsoft.Dynamics.CRM.PicklistAttributeMetadata?$select=LogicalName&$expand=OptionSet($select=Options)`;Promise.all([fetch(a).then(r=>r.json()),fetch(o).then(r=>r.json())]).then(([d,p])=>{const opts={};p.value.forEach(i=>{i.OptionSet?.Options&&(opts[i.LogicalName]=i.OptionSet.Options.map(o=>`${o.Value}: ${o.Label?.LocalizedLabels?.[0]?.Label||o.Value}`).join(', '))});const rows=d.Attributes.filter(a=>!a.LogicalName.match(/^(created|modified|owner|owning|statecode|statuscode|versionnumber|importsequencenumber|overriddencreatedon|timezoneruleversionnumber|utcconversiontimezonecode)/)).map(a=>{const name=a.DisplayName?.LocalizedLabels?.[0]?.Label||'',opt=opts[a.LogicalName]?` [${opts[a.LogicalName]}]`:'';return`| ${a.LogicalName} | ${name} | ${a.AttributeType}${opt} |`}).join('\n'),table=`**Table: ${e}**\n\n| LogicalName | DisplayName | AttributeType |\n|-------------|-------------|---------------|\n${rows}`;navigator.clipboard.writeText(table).then(()=>alert(`‚úì Schema copied!\n\n${d.Attributes.length} total, ${rows.split('\n').length} shown\n${Object.keys(opts).length} choice fields`))}).catch(err=>alert('Error: '+err.message))})();</pre>
        </details>

        <details style="margin-top: 10px;">
            <summary><strong>Usage</strong></summary>
            <ol>
                <li>Navigate to a table view in a model-driven app</li>
                <li>Click the bookmarklet</li>
                <li>Schema is copied to clipboard</li>
            </ol>
            <p><strong>What gets included:</strong></p>
            <ul>
                <li>All custom fields (filters out system fields like <code>createdon</code>, <code>modifiedby</code>, etc.)</li>
                <li>Choice/picklist values with IDs and labels (e.g., <code>Picklist [1: Draft, 2: Active]</code>)</li>
                <li>Works with any language (uses first available label from environment)</li>
            </ul>
        </details>

        <p style="margin-top: 10px;">
            <a href="https://github.com/jukkan/power-bookmarklets/blob/main/bookmarklets/get-table-metadata.js">üìÑ View source code</a>
        </p>
    </div>

    <div class="bookmarklet">
        <h3>‚ö° Get Flow JSON</h3>
        <p>Extracts Power Automate cloud flow definition from Dataverse and displays it in a formatted viewer. Perfect for analyzing flow structure, sharing with AI tools, or documentation.</p>

        <p><strong>Install:</strong> Drag this to your bookmarks bar ‚Üí</p>
        <a href="javascript:(function(){const history=JSON.parse(localStorage.getItem('paFlowHistory')||'[]');let flowId=prompt(history.length>0?'Enter Flow ID (or leave empty for recent flows):':'Enter Flow ID:');let selectedOrg=null;if(!flowId&&history.length>0){const list=history.map((f,i)=>`${i+1}. ${f.name} (${f.actions} actions) - ${f.org.split('.')[0]}`).join('\n');const choice=prompt(`Recent flows:\n\n${list}\n\nEnter number (1-${history.length}) or paste Flow ID:`);if(choice&&choice.match(/^\d+$/)){const idx=parseInt(choice)-1;if(idx>=0&&idx<history.length){flowId=history[idx].id;selectedOrg=history[idx].org;}}else{flowId=choice;}}if(!flowId||!flowId.match(/^[a-f0-9\-]{36}$/i)){if(flowId)alert('Invalid GUID format');return;}const searchId=flowId;const orgUrl=selectedOrg||window.location.hostname;const tryFetch=async(useUnique)=>{const query=useUnique?`workflows?$filter=workflowidunique eq ${flowId}&$select=workflowid,workflowidunique,clientdata,name,category`:`workflows?$filter=workflowid eq ${flowId}&$select=workflowid,workflowidunique,clientdata,name,category`;const r=await fetch(`https://${orgUrl}/api/data/v9.2/${query}`,{credentials:'include',headers:{'Accept':'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0'}});if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json();};const searchByName=async()=>{const name=prompt('Flow not found by ID.\n\nThis can happen with flows in the Default Solution.\n\nEnter part of the flow name to search:');if(!name)return null;const query=`workflows?$filter=contains(name,'${name}') and category eq 5&$select=workflowid,workflowidunique,name&$top=20`;const r=await fetch(`https://${orgUrl}/api/data/v9.2/${query}`,{credentials:'include',headers:{'Accept':'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0'}});if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json();};const showFlow=(wf)=>{const json=JSON.parse(wf.clientdata);const def=json.properties?.definition||{};const conn=json.properties?.connectionReferences||{};const trigs=def.triggers||{};const acts=def.actions||{};const trigNames=Object.keys(trigs);const trigDetails=trigNames.length>0?getTriggerDetails(trigs[trigNames[0]],trigNames[0]):{type:'Unknown',details:''};function getTriggerDetails(t,name){if(!t)return{type:'Unknown',details:''};const type=t.type||'Unknown';let details='';if(type==='OpenApiConnectionWebhook'){const entity=t.inputs?.parameters?.['subscriptionRequest/entityname']||'';const msg=t.inputs?.parameters?.['subscriptionRequest/message'];const msgMap={1:'Create',2:'Update',3:'Delete',4:'Create or Update or Delete'};details=entity?`Table: ${entity}`:'';if(msg)details+=` | Event: ${msgMap[msg]||msg}`;}else if(type==='Recurrence'){const interval=t.recurrence?.interval||'';const freq=t.recurrence?.frequency||'';details=interval&&freq?`Every ${interval} ${freq}`:'Scheduled';}else if(type==='Request'){const kind=t.kind||'';details=kind==='Button'?'Manual (Button)':'HTTP Request';}else if(type==='ApiConnectionWebhook'){const opId=t.inputs?.host?.operationId||'';details=opId||'Webhook';}return{type:type,details:details,name:name};}function extractVariables(){const vars={};Object.entries(acts).forEach(([name,action])=>{if(action.type==='InitializeVariable'&&action.inputs?.variables){action.inputs.variables.forEach(v=>{vars[v.name]={type:v.type,value:v.value,usedIn:[]}});}});Object.keys(vars).forEach(varName=>{vars[varName].usedIn=Object.entries(acts).filter(([name,action])=>{const actStr=JSON.stringify(action);return actStr.includes(`variables('${varName}')`)||actStr.includes(`variables(\"${varName}\")`);}).map(([name])=>name);});return vars;}const variables=extractVariables();function groupVariablesByType(vars){const grouped={};Object.entries(vars).forEach(([name,info])=>{const type=info.type||'unknown';if(!grouped[type])grouped[type]=[];grouped[type].push({name:name,...info});});return grouped;}const groupedVars=groupVariablesByType(variables);function minimizeForAI(json){const def=json.properties?.definition||{};const conn=json.properties?.connectionReferences||{};const mini={trigger:{},actions:{},connections:{}};const trig=Object.entries(def.triggers||{})[0];if(trig){const[name,t]=trig;mini.trigger={name:name,type:t.type};if(t.type==='OpenApiConnectionWebhook'){mini.trigger.table=t.inputs?.parameters?.['subscriptionRequest/entityname'];mini.trigger.event=t.inputs?.parameters?.['subscriptionRequest/message'];}else if(t.type==='Recurrence'){mini.trigger.schedule={interval:t.recurrence?.interval,frequency:t.recurrence?.frequency};}else if(t.type==='Request'){mini.trigger.kind=t.kind;}}Object.entries(def.actions||{}).forEach(([name,action])=>{const a={type:action.type};if(action.runAfter)a.runAfter=Object.keys(action.runAfter);if(action.type==='InitializeVariable'||action.type==='SetVariable'){a.variable=action.inputs?.variables?.[0]?.name||action.inputs?.name;a.varType=action.inputs?.variables?.[0]?.type;}else if(action.type==='If'){a.expression=action.expression;}else if(action.type==='Foreach'||action.type==='Until'){a.iterates=action.foreach||action.expression;}else if(action.type==='OpenApiConnection'){a.operation=action.inputs?.host?.operationId;a.connection=action.inputs?.host?.connectionName;}else if(action.type==='Workflow'){a.childFlow=action.inputs?.host?.workflowReferenceName;}if(action.actions)a.hasNestedActions=Object.keys(action.actions).length;if(action.else?.actions)a.hasElse=Object.keys(action.else.actions).length;mini.actions[name]=a;});Object.entries(conn).forEach(([key,ref])=>{mini.connections[key]=ref.api?.name||key;});return mini;}function highlightJSON(obj){let str=JSON.stringify(obj,null,2);str=str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');str=str.replace(/(\"(\\\\u[a-zA-Z0-9]{4}|\\\\[^u]|[^\\\\\"])*\"(\\s*:)?|\\b(true|false|null)\\b|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)/g,function(match){let cls='number';if(/^\"/.test(match)){if(/:$/.test(match)){cls='key';}else{cls='string';}}else if(/true|false/.test(match)){cls='boolean';}else if(/null/.test(match)){cls='null';}return'<span class=\"'+cls+'\">'+match+'</span>';});return str;}const historyEntry={id:wf.workflowidunique||wf.workflowid,name:wf.name,org:orgUrl,timestamp:new Date().toISOString(),actions:Object.keys(acts).length,variables:Object.keys(variables).length};const newHistory=[historyEntry,...history.filter(f=>!(f.id===(wf.workflowidunique||wf.workflowid)&&f.org===orgUrl))].slice(0,10);localStorage.setItem('paFlowHistory',JSON.stringify(newHistory));const w=window.open('','_blank','width=1200,height=800');w.document.write(`<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>${wf.name}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Segoe UI,sans-serif;background:#f3f2f1;padding:20px}.header{background:#0078d4;color:#fff;padding:20px;margin:-20px -20px 20px;border-radius:4px}.header-content{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px}.header-left h1{font-size:24px;margin-bottom:8px}.meta{font-size:13px;opacity:.9}.header-right{display:flex;gap:10px}.btn{background:#fff;color:#0078d4;border:none;padding:10px 20px;cursor:pointer;border-radius:4px;font-size:13px;font-weight:600;white-space:nowrap}.btn:hover{background:#f3f2f1}.btn:active{background:#e1dfdd}.btn-primary{background:#005a9e;color:#fff}.btn-primary:hover{background:#004578}.id-section{background:rgba(255,255,255,0.1);padding:12px;border-radius:4px;font-size:12px}.id-row{display:flex;align-items:center;margin-bottom:6px;gap:8px}.id-row:last-child{margin-bottom:0}.id-label{color:rgba(255,255,255,0.7);min-width:120px;font-weight:600}.id-value{font-family:Consolas,monospace;color:#fff;flex:1}.id-badge{background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:3px;font-size:10px;text-transform:uppercase;font-weight:600}.btn-copy-id{background:rgba(255,255,255,0.2);border:none;color:#fff;padding:4px 10px;cursor:pointer;border-radius:3px;font-size:11px}.btn-copy-id:hover{background:rgba(255,255,255,0.3)}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}.stat{background:#fff;padding:20px;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1);border-left:4px solid #0078d4}.stat-label{font-size:11px;color:#605e5c;text-transform:uppercase;margin-bottom:8px;font-weight:600}.stat-value{font-size:20px;font-weight:600;color:#323130;line-height:1.4}.trigger-detail{background:#fff;padding:20px;margin-bottom:20px;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1);border-left:4px solid #107c10}.trigger-label{font-size:11px;color:#605e5c;text-transform:uppercase;margin-bottom:8px;font-weight:600}.trigger-name{font-size:18px;font-weight:600;color:#323130;margin-bottom:4px}.trigger-type{font-size:13px;color:#605e5c;margin-bottom:4px}.trigger-details{font-size:13px;color:#323130}.card{background:#fff;padding:24px;margin-bottom:20px;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1)}.card-collapsible{cursor:pointer;user-select:none}.card-collapsible h2::before{content:'‚ñº ';font-size:12px;display:inline-block;transition:transform .2s}.card-collapsible.collapsed h2::before{transform:rotate(-90deg)}.card-content{max-height:2000px;overflow:hidden;transition:max-height .3s}.card-collapsible.collapsed .card-content{max-height:0}h2{color:#0078d4;font-size:18px;margin-bottom:16px}.var-type{margin-bottom:20px}.var-type-header{font-size:13px;font-weight:600;color:#605e5c;text-transform:uppercase;margin-bottom:8px}.var-item{padding:10px;background:#faf9f8;border-left:3px solid #0078d4;margin-bottom:8px;border-radius:0 4px 4px 0}.var-name{font-weight:600;color:#323130;font-size:14px;margin-bottom:4px}.var-meta{font-size:12px;color:#605e5c;margin-bottom:4px}.var-usage{font-size:11px;color:#107c10;margin-top:4px}.var-usage-item{display:inline-block;background:#e8f5e9;padding:2px 8px;margin:2px 4px 2px 0;border-radius:2px}pre{background:#1e1e1e;padding:16px;border-radius:4px;overflow:auto;font-size:12px;line-height:1.6;font-family:Consolas,monospace;max-height:600px;color:#d4d4d4}.key{color:#9cdcfe}.string{color:#ce9178}.number{color:#b5cea8}.boolean{color:#569cd6}.null{color:#569cd6}.tooltip{position:relative;display:inline-block;cursor:help;border-bottom:1px dotted rgba(255,255,255,0.5)}.tooltip:hover::after{content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:#fff;padding:8px 12px;border-radius:4px;font-size:11px;white-space:nowrap;z-index:1000;margin-bottom:5px}</style></head><body><div class=\"header\"><div class=\"header-content\"><div class=\"header-left\"><h1>${wf.name}</h1><div class=\"meta\">Org: ${orgUrl}</div></div><div class=\"header-right\"><button class=\"btn\" onclick=\"copyJSON()\">üìã Copy JSON</button><button class=\"btn btn-primary\" onclick=\"copyForAI()\">ü§ñ Copy for AI</button></div></div><div class=\"id-section\"><div class=\"id-row\"><div class=\"id-label\">Dataverse ID:</div><div class=\"id-value\">${wf.workflowid}</div>${searchId.toLowerCase()===wf.workflowid.toLowerCase()?'<span class=\"id-badge\">Used</span>':''}<button class=\"btn-copy-id\" onclick=\"copyToClipboard('${wf.workflowid}','Dataverse ID')\">Copy</button></div><div class=\"id-row\"><div class=\"id-label\"><span class=\"tooltip\" data-tooltip=\"Solution-portable ID - copy from solution explorer URL\">Maker Portal ID:</span></div><div class=\"id-value\">${wf.workflowidunique||'N/A'}</div>${wf.workflowidunique&&searchId.toLowerCase()===wf.workflowidunique.toLowerCase()?'<span class=\"id-badge\">Used</span>':''}<button class=\"btn-copy-id\" onclick=\"copyToClipboard('${wf.workflowidunique||''}','Maker Portal ID')\" ${!wf.workflowidunique?'disabled':''}>Copy</button></div></div></div><div class=\"stats\"><div class=\"stat\"><div class=\"stat-label\">Actions</div><div class=\"stat-value\">${Object.keys(acts).length}</div></div><div class=\"stat\"><div class=\"stat-label\">Variables</div><div class=\"stat-value\">${Object.keys(variables).length}</div></div><div class=\"stat\"><div class=\"stat-label\">Connections</div><div class=\"stat-value\">${Object.keys(conn).length}</div></div></div><div class=\"trigger-detail\"><div class=\"trigger-label\">üéØ Trigger</div><div class=\"trigger-name\">${trigDetails.name}</div><div class=\"trigger-type\">${trigDetails.type}</div>${trigDetails.details?`<div class=\"trigger-details\">${trigDetails.details}</div>`:''}</div>${Object.keys(variables).length>0?`<div class=\"card card-collapsible collapsed\" onclick=\"toggleCollapse(this)\"><h2>üìù Variables (${Object.keys(variables).length})</h2><div class=\"card-content\">${Object.entries(groupedVars).map(([type,vars])=>`<div class=\"var-type\"><div class=\"var-type-header\">${type}</div>${vars.map(v=>`<div class=\"var-item\"><div class=\"var-name\">${v.name}</div><div class=\"var-meta\">Type: ${v.type}${v.value!==undefined?' | Initial: '+JSON.stringify(v.value):''}</div>${v.usedIn.length>0?`<div class=\"var-usage\">Used in: ${v.usedIn.map(a=>`<span class=\"var-usage-item\">${a}</span>`).join('')}</div>`:''}</div>`).join('')}</div>`).join('')}</div></div>`:''}<div class=\"card\"><h2>üìù Full Definition</h2><pre id=\"json\">${highlightJSON(json)}</pre></div><div class=\"card\"><h2>üîó Connection References</h2><pre>${highlightJSON(conn)}</pre></div><script>const fullJSON=${JSON.stringify(json)};const miniJSON=${JSON.stringify(minimizeForAI(json))};function toggleCollapse(el){el.classList.toggle('collapsed');}function copyJSON(){navigator.clipboard.writeText(JSON.stringify(fullJSON,null,2)).then(()=>alert('‚úì Full JSON copied to clipboard!'))}function copyForAI(){const summary='Flow: ${wf.name}\\\\nDataverse ID: ${wf.workflowid}\\\\nMaker Portal ID: ${wf.workflowidunique||'N/A'}\\\\nActions: ${Object.keys(acts).length} | Variables: ${Object.keys(variables).length} | Connections: ${Object.keys(conn).length}\\\\nTrigger: ${trigDetails.type}${trigDetails.details?' - '+trigDetails.details:''}\\\\n\\\\nMinimized Definition:\\\\n'+JSON.stringify(miniJSON,null,2);navigator.clipboard.writeText(summary).then(()=>alert('‚úì AI-optimized summary copied!\\\\n\\\\nToken savings: ~'+(JSON.stringify(fullJSON).length-summary.length)+' chars'))}function copyToClipboard(text,label){if(!text)return;navigator.clipboard.writeText(text).then(()=>alert('‚úì '+label+' copied:\\\\n'+text))}<\\/script></body></html>`);};tryFetch(true).then(data=>{if(data.value&&data.value.length===0)return tryFetch(false);return data;}).then(async data=>{const wf=data.value?data.value[0]:data;if(!wf||!wf.clientdata){const searchData=await searchByName();if(!searchData||!searchData.value||searchData.value.length===0){alert('No flows found.');return;}if(searchData.value.length===1){const foundFlow=searchData.value[0];const confirmMsg=`Found 1 flow:\n\n${foundFlow.name}\n\nOpen this flow?`;if(confirm(confirmMsg)){flowId=foundFlow.workflowidunique||foundFlow.workflowid;return tryFetch(!!foundFlow.workflowidunique).then(d=>d.value?d.value[0]:d);}return;}const list=searchData.value.map((f,i)=>`${i+1}. ${f.name}`).join('\n');const choice=prompt(`Found ${searchData.value.length} flows:\n\n${list}\n\nEnter number to view:`);if(choice&&choice.match(/^\d+$/)){const idx=parseInt(choice)-1;if(idx>=0&&idx<searchData.value.length){const selectedFlow=searchData.value[idx];flowId=selectedFlow.workflowidunique||selectedFlow.workflowid;return tryFetch(!!selectedFlow.workflowidunique).then(d=>d.value?d.value[0]:d);}}return;}return wf;}).then(wf=>{if(wf&&wf.clientdata){showFlow(wf);}}).catch(e=>alert('Error: '+e.message));})();" class="drag-link">Get Flow JSON</a>

        <details style="margin-top: 15px;">
            <summary><strong>Manual install (if drag doesn't work)</strong></summary>
            <ol>
                <li>Right-click your bookmarks bar ‚Üí <code>Add page</code> or <code>Add bookmark</code></li>
                <li>Name: <code>Get Flow JSON</code></li>
                <li>URL: Copy the code below and paste it</li>
            </ol>
            <pre style="font-size: 11px; max-height: 150px; overflow-y: auto;">javascript:(function(){const history=JSON.parse(localStorage.getItem('paFlowHistory')||'[]');let flowId=prompt(history.length>0?'Enter Flow ID (or leave empty for recent flows):':'Enter Flow ID:');let selectedOrg=null;if(!flowId&&history.length>0){const list=history.map((f,i)=>`${i+1}. ${f.name} (${f.actions} actions) - ${f.org.split('.')[0]}`).join('\n');const choice=prompt(`Recent flows:\n\n${list}\n\nEnter number (1-${history.length}) or paste Flow ID:`);if(choice&&choice.match(/^\d+$/)){const idx=parseInt(choice)-1;if(idx>=0&&idx<history.length){flowId=history[idx].id;selectedOrg=history[idx].org;}}else{flowId=choice;}}if(!flowId||!flowId.match(/^[a-f0-9\-]{36}$/i)){if(flowId)alert('Invalid GUID format');return;}const searchId=flowId;const orgUrl=selectedOrg||window.location.hostname;const tryFetch=async(useUnique)=>{const query=useUnique?`workflows?$filter=workflowidunique eq ${flowId}&$select=workflowid,workflowidunique,clientdata,name,category`:`workflows?$filter=workflowid eq ${flowId}&$select=workflowid,workflowidunique,clientdata,name,category`;const r=await fetch(`https://${orgUrl}/api/data/v9.2/${query}`,{credentials:'include',headers:{'Accept':'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0'}});if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json();};const searchByName=async()=>{const name=prompt('Flow not found by ID.\n\nThis can happen with flows in the Default Solution.\n\nEnter part of the flow name to search:');if(!name)return null;const query=`workflows?$filter=contains(name,'${name}') and category eq 5&$select=workflowid,workflowidunique,name&$top=20`;const r=await fetch(`https://${orgUrl}/api/data/v9.2/${query}`,{credentials:'include',headers:{'Accept':'application/json','OData-MaxVersion':'4.0','OData-Version':'4.0'}});if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json();};const showFlow=(wf)=>{const json=JSON.parse(wf.clientdata);const def=json.properties?.definition||{};const conn=json.properties?.connectionReferences||{};const trigs=def.triggers||{};const acts=def.actions||{};const trigNames=Object.keys(trigs);const trigDetails=trigNames.length>0?getTriggerDetails(trigs[trigNames[0]],trigNames[0]):{type:'Unknown',details:''};function getTriggerDetails(t,name){if(!t)return{type:'Unknown',details:''};const type=t.type||'Unknown';let details='';if(type==='OpenApiConnectionWebhook'){const entity=t.inputs?.parameters?.['subscriptionRequest/entityname']||'';const msg=t.inputs?.parameters?.['subscriptionRequest/message'];const msgMap={1:'Create',2:'Update',3:'Delete',4:'Create or Update or Delete'};details=entity?`Table: ${entity}`:'';if(msg)details+=` | Event: ${msgMap[msg]||msg}`;}else if(type==='Recurrence'){const interval=t.recurrence?.interval||'';const freq=t.recurrence?.frequency||'';details=interval&&freq?`Every ${interval} ${freq}`:'Scheduled';}else if(type==='Request'){const kind=t.kind||'';details=kind==='Button'?'Manual (Button)':'HTTP Request';}else if(type==='ApiConnectionWebhook'){const opId=t.inputs?.host?.operationId||'';details=opId||'Webhook';}return{type:type,details:details,name:name};}function extractVariables(){const vars={};Object.entries(acts).forEach(([name,action])=>{if(action.type==='InitializeVariable'&&action.inputs?.variables){action.inputs.variables.forEach(v=>{vars[v.name]={type:v.type,value:v.value,usedIn:[]}});}});Object.keys(vars).forEach(varName=>{vars[varName].usedIn=Object.entries(acts).filter(([name,action])=>{const actStr=JSON.stringify(action);return actStr.includes(`variables('${varName}')`)||actStr.includes(`variables(\"${varName}\")`);}).map(([name])=>name);});return vars;}const variables=extractVariables();function groupVariablesByType(vars){const grouped={};Object.entries(vars).forEach(([name,info])=>{const type=info.type||'unknown';if(!grouped[type])grouped[type]=[];grouped[type].push({name:name,...info});});return grouped;}const groupedVars=groupVariablesByType(variables);function minimizeForAI(json){const def=json.properties?.definition||{};const conn=json.properties?.connectionReferences||{};const mini={trigger:{},actions:{},connections:{}};const trig=Object.entries(def.triggers||{})[0];if(trig){const[name,t]=trig;mini.trigger={name:name,type:t.type};if(t.type==='OpenApiConnectionWebhook'){mini.trigger.table=t.inputs?.parameters?.['subscriptionRequest/entityname'];mini.trigger.event=t.inputs?.parameters?.['subscriptionRequest/message'];}else if(t.type==='Recurrence'){mini.trigger.schedule={interval:t.recurrence?.interval,frequency:t.recurrence?.frequency};}else if(t.type==='Request'){mini.trigger.kind=t.kind;}}Object.entries(def.actions||{}).forEach(([name,action])=>{const a={type:action.type};if(action.runAfter)a.runAfter=Object.keys(action.runAfter);if(action.type==='InitializeVariable'||action.type==='SetVariable'){a.variable=action.inputs?.variables?.[0]?.name||action.inputs?.name;a.varType=action.inputs?.variables?.[0]?.type;}else if(action.type==='If'){a.expression=action.expression;}else if(action.type==='Foreach'||action.type==='Until'){a.iterates=action.foreach||action.expression;}else if(action.type==='OpenApiConnection'){a.operation=action.inputs?.host?.operationId;a.connection=action.inputs?.host?.connectionName;}else if(action.type==='Workflow'){a.childFlow=action.inputs?.host?.workflowReferenceName;}if(action.actions)a.hasNestedActions=Object.keys(action.actions).length;if(action.else?.actions)a.hasElse=Object.keys(action.else.actions).length;mini.actions[name]=a;});Object.entries(conn).forEach(([key,ref])=>{mini.connections[key]=ref.api?.name||key;});return mini;}function highlightJSON(obj){let str=JSON.stringify(obj,null,2);str=str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');str=str.replace(/(\"(\\\\u[a-zA-Z0-9]{4}|\\\\[^u]|[^\\\\\"])*\"(\\s*:)?|\\b(true|false|null)\\b|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)/g,function(match){let cls='number';if(/^\"/.test(match)){if(/:$/.test(match)){cls='key';}else{cls='string';}}else if(/true|false/.test(match)){cls='boolean';}else if(/null/.test(match)){cls='null';}return'<span class=\"'+cls+'\">'+match+'</span>';});return str;}const historyEntry={id:wf.workflowidunique||wf.workflowid,name:wf.name,org:orgUrl,timestamp:new Date().toISOString(),actions:Object.keys(acts).length,variables:Object.keys(variables).length};const newHistory=[historyEntry,...history.filter(f=>!(f.id===(wf.workflowidunique||wf.workflowid)&&f.org===orgUrl))].slice(0,10);localStorage.setItem('paFlowHistory',JSON.stringify(newHistory));const w=window.open('','_blank','width=1200,height=800');w.document.write(`<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>${wf.name}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Segoe UI,sans-serif;background:#f3f2f1;padding:20px}.header{background:#0078d4;color:#fff;padding:20px;margin:-20px -20px 20px;border-radius:4px}.header-content{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px}.header-left h1{font-size:24px;margin-bottom:8px}.meta{font-size:13px;opacity:.9}.header-right{display:flex;gap:10px}.btn{background:#fff;color:#0078d4;border:none;padding:10px 20px;cursor:pointer;border-radius:4px;font-size:13px;font-weight:600;white-space:nowrap}.btn:hover{background:#f3f2f1}.btn:active{background:#e1dfdd}.btn-primary{background:#005a9e;color:#fff}.btn-primary:hover{background:#004578}.id-section{background:rgba(255,255,255,0.1);padding:12px;border-radius:4px;font-size:12px}.id-row{display:flex;align-items:center;margin-bottom:6px;gap:8px}.id-row:last-child{margin-bottom:0}.id-label{color:rgba(255,255,255,0.7);min-width:120px;font-weight:600}.id-value{font-family:Consolas,monospace;color:#fff;flex:1}.id-badge{background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:3px;font-size:10px;text-transform:uppercase;font-weight:600}.btn-copy-id{background:rgba(255,255,255,0.2);border:none;color:#fff;padding:4px 10px;cursor:pointer;border-radius:3px;font-size:11px}.btn-copy-id:hover{background:rgba(255,255,255,0.3)}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}.stat{background:#fff;padding:20px;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1);border-left:4px solid #0078d4}.stat-label{font-size:11px;color:#605e5c;text-transform:uppercase;margin-bottom:8px;font-weight:600}.stat-value{font-size:20px;font-weight:600;color:#323130;line-height:1.4}.trigger-detail{background:#fff;padding:20px;margin-bottom:20px;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1);border-left:4px solid #107c10}.trigger-label{font-size:11px;color:#605e5c;text-transform:uppercase;margin-bottom:8px;font-weight:600}.trigger-name{font-size:18px;font-weight:600;color:#323130;margin-bottom:4px}.trigger-type{font-size:13px;color:#605e5c;margin-bottom:4px}.trigger-details{font-size:13px;color:#323130}.card{background:#fff;padding:24px;margin-bottom:20px;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1)}.card-collapsible{cursor:pointer;user-select:none}.card-collapsible h2::before{content:'‚ñº ';font-size:12px;display:inline-block;transition:transform .2s}.card-collapsible.collapsed h2::before{transform:rotate(-90deg)}.card-content{max-height:2000px;overflow:hidden;transition:max-height .3s}.card-collapsible.collapsed .card-content{max-height:0}h2{color:#0078d4;font-size:18px;margin-bottom:16px}.var-type{margin-bottom:20px}.var-type-header{font-size:13px;font-weight:600;color:#605e5c;text-transform:uppercase;margin-bottom:8px}.var-item{padding:10px;background:#faf9f8;border-left:3px solid #0078d4;margin-bottom:8px;border-radius:0 4px 4px 0}.var-name{font-weight:600;color:#323130;font-size:14px;margin-bottom:4px}.var-meta{font-size:12px;color:#605e5c;margin-bottom:4px}.var-usage{font-size:11px;color:#107c10;margin-top:4px}.var-usage-item{display:inline-block;background:#e8f5e9;padding:2px 8px;margin:2px 4px 2px 0;border-radius:2px}pre{background:#1e1e1e;padding:16px;border-radius:4px;overflow:auto;font-size:12px;line-height:1.6;font-family:Consolas,monospace;max-height:600px;color:#d4d4d4}.key{color:#9cdcfe}.string{color:#ce9178}.number{color:#b5cea8}.boolean{color:#569cd6}.null{color:#569cd6}.tooltip{position:relative;display:inline-block;cursor:help;border-bottom:1px dotted rgba(255,255,255,0.5)}.tooltip:hover::after{content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:#fff;padding:8px 12px;border-radius:4px;font-size:11px;white-space:nowrap;z-index:1000;margin-bottom:5px}</style></head><body><div class=\"header\"><div class=\"header-content\"><div class=\"header-left\"><h1>${wf.name}</h1><div class=\"meta\">Org: ${orgUrl}</div></div><div class=\"header-right\"><button class=\"btn\" onclick=\"copyJSON()\">üìã Copy JSON</button><button class=\"btn btn-primary\" onclick=\"copyForAI()\">ü§ñ Copy for AI</button></div></div><div class=\"id-section\"><div class=\"id-row\"><div class=\"id-label\">Dataverse ID:</div><div class=\"id-value\">${wf.workflowid}</div>${searchId.toLowerCase()===wf.workflowid.toLowerCase()?'<span class=\"id-badge\">Used</span>':''}<button class=\"btn-copy-id\" onclick=\"copyToClipboard('${wf.workflowid}','Dataverse ID')\">Copy</button></div><div class=\"id-row\"><div class=\"id-label\"><span class=\"tooltip\" data-tooltip=\"Solution-portable ID - copy from solution explorer URL\">Maker Portal ID:</span></div><div class=\"id-value\">${wf.workflowidunique||'N/A'}</div>${wf.workflowidunique&&searchId.toLowerCase()===wf.workflowidunique.toLowerCase()?'<span class=\"id-badge\">Used</span>':''}<button class=\"btn-copy-id\" onclick=\"copyToClipboard('${wf.workflowidunique||''}','Maker Portal ID')\" ${!wf.workflowidunique?'disabled':''}>Copy</button></div></div></div><div class=\"stats\"><div class=\"stat\"><div class=\"stat-label\">Actions</div><div class=\"stat-value\">${Object.keys(acts).length}</div></div><div class=\"stat\"><div class=\"stat-label\">Variables</div><div class=\"stat-value\">${Object.keys(variables).length}</div></div><div class=\"stat\"><div class=\"stat-label\">Connections</div><div class=\"stat-value\">${Object.keys(conn).length}</div></div></div><div class=\"trigger-detail\"><div class=\"trigger-label\">üéØ Trigger</div><div class=\"trigger-name\">${trigDetails.name}</div><div class=\"trigger-type\">${trigDetails.type}</div>${trigDetails.details?`<div class=\"trigger-details\">${trigDetails.details}</div>`:''}</div>${Object.keys(variables).length>0?`<div class=\"card card-collapsible collapsed\" onclick=\"toggleCollapse(this)\"><h2>üìù Variables (${Object.keys(variables).length})</h2><div class=\"card-content\">${Object.entries(groupedVars).map(([type,vars])=>`<div class=\"var-type\"><div class=\"var-type-header\">${type}</div>${vars.map(v=>`<div class=\"var-item\"><div class=\"var-name\">${v.name}</div><div class=\"var-meta\">Type: ${v.type}${v.value!==undefined?' | Initial: '+JSON.stringify(v.value):''}</div>${v.usedIn.length>0?`<div class=\"var-usage\">Used in: ${v.usedIn.map(a=>`<span class=\"var-usage-item\">${a}</span>`).join('')}</div>`:''}</div>`).join('')}</div>`).join('')}</div></div>`:''}<div class=\"card\"><h2>üìù Full Definition</h2><pre id=\"json\">${highlightJSON(json)}</pre></div><div class=\"card\"><h2>üîó Connection References</h2><pre>${highlightJSON(conn)}</pre></div><script>const fullJSON=${JSON.stringify(json)};const miniJSON=${JSON.stringify(minimizeForAI(json))};function toggleCollapse(el){el.classList.toggle('collapsed');}function copyJSON(){navigator.clipboard.writeText(JSON.stringify(fullJSON,null,2)).then(()=>alert('‚úì Full JSON copied to clipboard!'))}function copyForAI(){const summary='Flow: ${wf.name}\\\\nDataverse ID: ${wf.workflowid}\\\\nMaker Portal ID: ${wf.workflowidunique||'N/A'}\\\\nActions: ${Object.keys(acts).length} | Variables: ${Object.keys(variables).length} | Connections: ${Object.keys(conn).length}\\\\nTrigger: ${trigDetails.type}${trigDetails.details?' - '+trigDetails.details:''}\\\\n\\\\nMinimized Definition:\\\\n'+JSON.stringify(miniJSON,null,2);navigator.clipboard.writeText(summary).then(()=>alert('‚úì AI-optimized summary copied!\\\\n\\\\nToken savings: ~'+(JSON.stringify(fullJSON).length-summary.length)+' chars'))}function copyToClipboard(text,label){if(!text)return;navigator.clipboard.writeText(text).then(()=>alert('‚úì '+label+' copied:\\\\n'+text))}<\\/script></body></html>`);};tryFetch(true).then(data=>{if(data.value&&data.value.length===0)return tryFetch(false);return data;}).then(async data=>{const wf=data.value?data.value[0]:data;if(!wf||!wf.clientdata){const searchData=await searchByName();if(!searchData||!searchData.value||searchData.value.length===0){alert('No flows found.');return;}if(searchData.value.length===1){const foundFlow=searchData.value[0];const confirmMsg=`Found 1 flow:\n\n${foundFlow.name}\n\nOpen this flow?`;if(confirm(confirmMsg)){flowId=foundFlow.workflowidunique||foundFlow.workflowid;return tryFetch(!!foundFlow.workflowidunique).then(d=>d.value?d.value[0]:d);}return;}const list=searchData.value.map((f,i)=>`${i+1}. ${f.name}`).join('\n');const choice=prompt(`Found ${searchData.value.length} flows:\n\n${list}\n\nEnter number to view:`);if(choice&&choice.match(/^\d+$/)){const idx=parseInt(choice)-1;if(idx>=0&&idx<searchData.value.length){const selectedFlow=searchData.value[idx];flowId=selectedFlow.workflowidunique||selectedFlow.workflowid;return tryFetch(!!selectedFlow.workflowidunique).then(d=>d.value?d.value[0]:d);}}return;}return wf;}).then(wf=>{if(wf&&wf.clientdata){showFlow(wf);}}).catch(e=>alert('Error: '+e.message));})();</pre>
        </details>

        <details style="margin-top: 10px;">
            <summary><strong>Usage</strong></summary>
            <ol>
                <li>Navigate to any Power Platform page (maker portal, model-driven app, etc.)</li>
                <li>Click the bookmarklet</li>
                <li>Enter a Flow ID (GUID) - either the Dataverse ID or Maker Portal ID</li>
                <li>Flow definition opens in a new window with formatted viewer</li>
            </ol>
            <p><strong>Features:</strong></p>
            <ul>
                <li><strong>Recent flows history:</strong> Remembers the last 10 flows you've viewed for quick access</li>
                <li><strong>Flow search:</strong> Can search flows by name if ID lookup fails</li>
                <li><strong>Two export formats:</strong> Full JSON or AI-optimized minimized version</li>
                <li><strong>Variable analysis:</strong> Shows all flow variables grouped by type with usage tracking</li>
                <li><strong>Trigger details:</strong> Displays trigger type, schedule, table, and event information</li>
                <li><strong>Connection references:</strong> Lists all connections used by the flow</li>
            </ul>
        </details>

        <p style="margin-top: 10px;">
            <a href="https://github.com/jukkan/power-bookmarklets/blob/main/bookmarklets/get-flow-json.js">üìÑ View source code</a>
        </p>
    </div>

    <hr style="margin: 40px 0;">

    <p><a href="https://github.com/jukkan/power-bookmarklets">‚¨ÖÔ∏è Back to GitHub repo</a></p>
</body>
</html>